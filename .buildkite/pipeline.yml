agents:
  image: "docker.elastic.co/ci-agent-images/ems/buildkite-agent:latest"
  cpu: "2"
  memory: "4G"

steps:
  - key: build
    label: ":hammer_and_wrench: Build"
    command: ".buildkite/scripts/build.sh"
    artifact_paths: release.tar.gz


  - key: deploy-staging
    label: ":rocket: Deploy to the staging environment"
    #TODO remove PR branch name
    if: |
      // Deploy to stage for whitelisted branches
      // and untagged commits
      build.tag == null && 
      build.branch =~ /master|v7\.17|v8\.6|v8\.7|v8\.8|jsanz:buildkite-deploy/
    depends_on: build
    command: ".buildkite/scripts/deploy-staging.sh"
    env:
      EMS_ENVIRONMENT: "staging"


  # - key: deploy-production
  #   label: ":rocket: Deploy to the production environment"
  #   #TODO remove PR branch name
  #   if: |
  #     // Deploy to stage for whitelisted branches
  #     // and untagged commits
  #     build.tag != null && 
  #     [ "master", "v7.17", "v8.6", "v8.7", "v8.8", "jsanz:buildkite-deploy" ] includes build.branch
  #   depends_on: build
  #   command: ".buildkite/scripts/deploy-production.sh"
  #   env:
  #     EMS_ENVIRONMENT: "production"